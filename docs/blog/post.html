<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading... - Agriculture SoC Blog</title>
    <style>
        :root {
            --green-dark: #2d5016;
            --green-mid: #4a7c29;
            --green-light: #6ba33e;
            --green-pale: #e8f5e0;
            --brown: #8b6914;
            --brown-light: #f5f0e0;
            --text: #1a1a1a;
            --text-muted: #555;
            --white: #fff;
            --gray-light: #f7f8fa;
            --border: #e0e0e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text);
            line-height: 1.7;
            background: var(--gray-light);
        }

        /* Top bar */
        .topbar {
            background: var(--green-dark);
            padding: 0.8rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .topbar a:hover { color: var(--white); }

        .topbar .site-name {
            font-weight: 700;
            font-size: 1rem;
        }

        /* Article */
        article {
            max-width: 760px;
            margin: 2rem auto;
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 3rem;
        }

        .blog-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .blog-meta .author {
            color: var(--green-mid);
            font-weight: 600;
        }

        article h1 {
            font-size: 2rem;
            color: var(--green-dark);
            margin-bottom: 1.5rem;
            line-height: 1.3;
        }

        article h2 {
            font-size: 1.3rem;
            color: var(--green-dark);
            margin-top: 2rem;
            margin-bottom: 0.8rem;
        }

        article p {
            margin-bottom: 1rem;
            color: var(--text);
        }

        article ul, article ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        article li {
            margin-bottom: 0.4rem;
        }

        pre {
            position: relative;
            background: #1e1e2e;
            color: #cdd6f4;
            border-radius: 6px;
            padding: 1.2rem;
            overflow-x: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        pre .code-lang {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.2rem 0.6rem;
            font-size: 0.7rem;
            color: #888;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            user-select: none;
        }

        code {
            font-family: "SF Mono", "Fira Code", "Fira Mono", Menlo, Consolas, monospace;
        }

        pre code.hljs {
            background: transparent;
            padding: 0;
        }

        p code, li code {
            background: var(--gray-light);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.88em;
            color: var(--green-dark);
        }

        /* Callouts rendered from blockquotes */
        blockquote {
            background: var(--green-pale);
            border-left: 4px solid var(--green-mid);
            border-radius: 0 6px 6px 0;
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
        }

        blockquote p { margin-bottom: 0; color: var(--text-muted); }

        .math-display {
            background: var(--gray-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .back-link {
            display: inline-block;
            margin-top: 2rem;
            padding: 0.6rem 1.2rem;
            background: var(--green-pale);
            color: var(--green-dark);
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .back-link:hover {
            background: var(--green-mid);
            color: var(--white);
        }

        /* Error state */
        .error-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .error-message h1 {
            color: var(--text-muted);
            font-size: 1.5rem;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        footer a { color: var(--green-mid); text-decoration: none; }

        @media (max-width: 600px) {
            article { margin: 1rem; padding: 1.5rem; }
            article h1 { font-size: 1.5rem; }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>
<body>

<div class="topbar">
    <a href="../" class="site-name">Agriculture SoC</a>
    <a href="../#blog">&larr; All Posts</a>
</div>

<article id="article">
    <p style="color: var(--text-muted);">Loading...</p>
</article>

<footer>
    <a href="https://github.com/lewisMW/agriculture-SoC">Agriculture SoC</a> &middot;
    SoC Labs Design Contest 2024/25
</footer>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/verilog.min.js"></script>
<script>
    (async function() {
        const params = new URLSearchParams(window.location.search);
        const slug = params.get('post');
        const article = document.getElementById('article');

        if (!slug) {
            showError('No post specified.');
            return;
        }

        try {
            const [metaRes, mdRes] = await Promise.all([
                fetch('posts.json'),
                fetch(slug + '.md')
            ]);

            if (!mdRes.ok) {
                showError('Post not found.');
                return;
            }

            const posts = await metaRes.json();
            const md = await mdRes.text();
            const meta = posts.find(p => p.slug === slug);

            // Build the page
            let header = '';
            if (meta) {
                document.title = meta.title + ' - Agriculture SoC Blog';
                header = '<div class="blog-meta"><span class="author">' + meta.author + '</span> &middot; ' + meta.date + '</div>'
                       + '<h1>' + meta.title + '</h1>';
            }

            // Protect math from markdown processing
            // Display math: HTML comment placeholders (safe on their own line)
            // Inline math: <span> placeholders (preserved as inline HTML in blockquotes)
            var mathBlocks = [];
            var processed = md.replace(/\$\$([\s\S]*?)\$\$/g, function(match) {
                mathBlocks.push({text: match, display: true});
                return '<!--MATH' + (mathBlocks.length - 1) + '-->';
            });
            processed = processed.replace(/\$([^\$\n]+?)\$/g, function(match) {
                mathBlocks.push({text: match, display: false});
                return '<span data-math="' + (mathBlocks.length - 1) + '"></span>';
            });

            var html = marked.parse(processed);

            // Restore math blocks, wrapping display math in a styled div
            mathBlocks.forEach(function(block, i) {
                if (block.display) {
                    html = html.replace('<!--MATH' + i + '-->', '<div class="math-display">' + block.text + '</div>');
                } else {
                    html = html.replace('<span data-math="' + i + '"></span>', block.text);
                }
            });

            article.innerHTML = header + html
                + '<a href="../#blog" class="back-link">&larr; Back to all posts</a>';

            // Syntax highlighting + language labels
            article.querySelectorAll('pre code[class*="language-"]').forEach(function(code) {
                var lang = code.className.match(/language-(\w+)/);
                if (lang) {
                    var label = document.createElement('span');
                    label.className = 'code-lang';
                    label.textContent = lang[1];
                    code.parentElement.appendChild(label);
                }
            });
            hljs.highlightAll();

            // Render math with KaTeX
            renderMathInElement(article, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });
        } catch (e) {
            showError('Failed to load post.');
        }

        function showError(msg) {
            article.innerHTML = '<div class="error-message"><h1>' + msg + '</h1>'
                + '<a href="../#blog" class="back-link">&larr; Back to all posts</a></div>';
        }
    })();
</script>

</body>
</html>
