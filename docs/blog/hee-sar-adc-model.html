<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAR ADC Behavioural Model &amp; Testbench - Agriculture SoC Blog</title>
    <style>
        :root {
            --green-dark: #2d5016;
            --green-mid: #4a7c29;
            --green-light: #6ba33e;
            --green-pale: #e8f5e0;
            --brown: #8b6914;
            --brown-light: #f5f0e0;
            --text: #1a1a1a;
            --text-muted: #555;
            --white: #fff;
            --gray-light: #f7f8fa;
            --border: #e0e0e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text);
            line-height: 1.7;
            background: var(--gray-light);
        }

        /* Top bar */
        .topbar {
            background: var(--green-dark);
            padding: 0.8rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .topbar a:hover { color: var(--white); }

        .topbar .site-name {
            font-weight: 700;
            font-size: 1rem;
        }

        /* Article */
        article {
            max-width: 760px;
            margin: 2rem auto;
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 3rem;
        }

        .blog-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .blog-meta .author {
            color: var(--green-mid);
            font-weight: 600;
        }

        article h1 {
            font-size: 2rem;
            color: var(--green-dark);
            margin-bottom: 1.5rem;
            line-height: 1.3;
        }

        article h2 {
            font-size: 1.3rem;
            color: var(--green-dark);
            margin-top: 2rem;
            margin-bottom: 0.8rem;
        }

        article p {
            margin-bottom: 1rem;
            color: var(--text);
        }

        article ul, article ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        article li {
            margin-bottom: 0.4rem;
        }

        pre {
            background: #1e1e2e;
            color: #cdd6f4;
            border-radius: 6px;
            padding: 1.2rem;
            overflow-x: auto;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        code {
            font-family: "SF Mono", "Fira Code", "Fira Mono", Menlo, Consolas, monospace;
        }

        p code {
            background: var(--gray-light);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.88em;
            color: var(--green-dark);
        }

        .callout {
            background: var(--green-pale);
            border-left: 4px solid var(--green-mid);
            border-radius: 0 6px 6px 0;
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
        }

        .callout p { margin-bottom: 0; color: var(--text-muted); }

        .math-block {
            background: var(--gray-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem 1.2rem;
            margin-bottom: 1rem;
            font-family: "Georgia", "Times New Roman", serif;
            font-style: italic;
            text-align: center;
            font-size: 1rem;
        }

        .back-link {
            display: inline-block;
            margin-top: 2rem;
            padding: 0.6rem 1.2rem;
            background: var(--green-pale);
            color: var(--green-dark);
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .back-link:hover {
            background: var(--green-mid);
            color: var(--white);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        footer a { color: var(--green-mid); text-decoration: none; }

        @media (max-width: 600px) {
            article { margin: 1rem; padding: 1.5rem; }
            article h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<div class="topbar">
    <a href="../" class="site-name">Agriculture SoC</a>
    <a href="../#blog">&larr; All Posts</a>
</div>

<article>
    <div class="blog-meta"><span class="author">Hee Chan</span> &middot; 30 January 2026</div>
    <h1>SAR ADC Behavioural Model &amp; Testbench in Verilog-AMS</h1>

    <p>
        The analogue-to-digital converter is the critical bridge between the real-world
        sensor signals and the digital processing on our Cortex-M0. I've been developing
        a behavioural model of an 8-bit Successive Approximation Register (SAR) ADC in
        Verilog-AMS, along with a Cadence Virtuoso testbench to verify its operation.
    </p>

    <h2>Why a SAR ADC?</h2>
    <p>
        For our precision agriculture application, we need an ADC that balances
        resolution, power consumption, and conversion speed. A SAR architecture is well
        suited because:
    </p>
    <ul>
        <li>Low power &mdash; only one comparator, no continuous-time circuits</li>
        <li>Moderate speed &mdash; 100 kHz sample rate is achievable at 8-bit resolution</li>
        <li>Compact area &mdash; important for a multi-sensor SoC</li>
        <li>8-bit resolution gives adequate precision for soil moisture and temperature readings</li>
    </ul>

    <h2>How the SAR Algorithm Works</h2>
    <p>
        The SAR ADC performs a binary search on the input voltage. Starting from the MSB,
        it sets each bit to 1, compares the resulting DAC voltage against the sampled input,
        and keeps or clears the bit. After N clock cycles (one per bit), the conversion
        is complete.
    </p>

    <p>The core conversion loop in the Verilog-AMS model:</p>

<pre><code>always @(posedge clk or negedge resetn) begin
    if(~resetn) begin
        i &lt;= BITS-1;
        buffer &lt;= 1 &lt;&lt; (BITS-1);  // Start with MSB = 1
        DATA &lt;= {BITS{1'b0}};
        data_valid &lt;= 1'b0;
    end else begin
        data_valid &lt;= 1'b0;

        if(i==0) begin
            // Final bit comparison, output result
            if (sample &gt; cmp)
                DATA &lt;= {buffer[BITS-1:1], 1'b1};
            else
                DATA &lt;= {buffer[BITS-1:1], 1'b0};
            data_valid &lt;= 1'b1;

            // Reset for next conversion
            buffer &lt;= 1 &lt;&lt; (BITS-1);
            i &lt;= BITS-1;
        end else begin
            // Sample on first cycle, then binary search
            if (i == BITS-1)
                sample &lt;= V(EXTIN);  // Analogue input read

            if (sample &gt; cmp) buffer[i] &lt;= 1'b1;
            else buffer[i] &lt;= 1'b0;

            buffer[i-1] &lt;= 1'b1;  // Try next bit
            i &lt;= i-1;
        end
    end
end</code></pre>

    <div class="callout">
        <p>
            The model uses the <code>electrical</code> discipline for the analogue input
            <code>EXTIN</code>, allowing it to accept continuous voltage signals from
            upstream analogue blocks. The comparator reference is computed as
            <code>VREF &times; buffer / 2<sup>BITS</sup></code>, performing the DAC function
            implicitly. Input clamping to the [0, VREF] range is included for robustness.
        </p>
    </div>

    <h2>Noise Budget &amp; SNR Analysis</h2>
    <p>
        Before building the model, I derived the noise requirements that the full
        analogue chain must meet. For an ideal 8-bit ADC with V<sub>REF</sub> = 1.2 V:
    </p>

    <div class="math-block">
        SNR<sub>ideal</sub> = 6.02N + 1.76 = 6.02(8) + 1.76 = 49.9 dB
    </div>

    <p>
        The quantisation noise floor sets the baseline. The LSB is
        V<sub>REF</sub> / 2<sup>8</sup> = 4.69 mV, giving a quantisation noise RMS
        of LSB / &radic;12 = 1.35 mV.
    </p>

    <p>
        Allowing a 3 dB SNR degradation from non-quantisation sources (amplifier noise,
        resistor thermal noise, interference), the maximum permitted non-quantisation
        noise is:
    </p>

    <div class="math-block">
        V<sub>nonq</sub> = V<sub>q</sub> &times; &radic;(10<sup>&Delta;/10</sup> - 1) = 1.35 mV &times; &radic;(10<sup>0.3</sup> - 1) = 1.35 mV
    </div>

    <p>
        This 1.35 mV budget is what Jaime's amplifier and filter stage must stay
        within &mdash; the thermal noise modelled in the <code>var_amp_va</code>
        component feeds directly into this analysis.
    </p>

    <h2>Equivalent Noise Bandwidth</h2>
    <p>
        For the anti-aliasing filter (a first-order low-pass with f<sub>c</sub> = 40 kHz),
        the equivalent noise bandwidth is:
    </p>

    <div class="math-block">
        ENBW = 1.571 &times; f<sub>c</sub> = 1.571 &times; 40 kHz = 62.8 kHz
    </div>

    <p>
        This is used to compute the total integrated noise from any broadband noise
        sources in the signal chain, ensuring the 3 dB SNR loss target is met.
    </p>

    <h2>Testbench Setup</h2>
    <p>
        The testbench (<code>ADC_tb</code>) instantiates the SAR ADC with a 200 kHz clock
        and applies a constant 0.6 V DC input (mid-scale) as a sanity check. It includes:
    </p>
    <ul>
        <li>Active-low reset held for 20 &mu;s before release</li>
        <li>A constant analogue stimulus via <code>V(EXTIN) &lt;+ 0.6</code></li>
        <li>Monitoring of the <code>data_valid</code> strobe and 8-bit output</li>
    </ul>

    <p>
        A separate digital stimulus module (<code>dig_sti_tb</code>) provides an 800 kHz
        clock for 8-bit conversion at 100 kHz effective sample rate, with a properly
        sequenced reset.
    </p>

    <p>
        Simulation is orchestrated through Cadence ADE Maestro, with results stored
        in the project's simulation history for team review.
    </p>

    <h2>Cadence Setup Documentation</h2>
    <p>
        As part of this work, I also contributed to a Cadence setup manual documenting
        the workflow for setting up Virtuoso projects, running ADE Maestro simulations,
        and managing Verilog-AMS models. This guide helps onboard team members who are
        new to the Cadence environment.
    </p>

    <h2>Next Steps</h2>
    <p>
        The immediate next steps are to connect this ADC model with Jaime's amplifier
        and filter library to form the complete analogue signal chain, and to run
        end-to-end simulations with realistic sensor waveforms rather than DC inputs.
        We also plan to add DNL/INL characterisation to the testbench to verify
        linearity.
    </p>

    <a href="../#blog" class="back-link">&larr; Back to all posts</a>
</article>

<footer>
    <a href="https://github.com/lewisMW/agriculture-SoC">Agriculture SoC</a> &middot;
    SoC Labs Design Contest 2024/25
</footer>

</body>
</html>
